<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-name="capitulos.CapitulosAccordionWidget">
        <div class="o_field_widget">
            <!-- Header con estilo nativo de Odoo -->
            <div class="d-flex justify-content-between align-items-center mb-3 p-2 bg-light border rounded">
                <h5 class="mb-0 text-primary">
                    <i class="fa fa-list-alt me-2"/> Capítulos del Presupuesto
                </h5>
                <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-info text-dark">
                        Total: <span t-esc="formatCurrency(0)"/>
                    </span>
                </div>
            </div>
            
            <!-- Accordion de capítulos con clases Bootstrap/Odoo -->
            <div class="accordion" id="capitulosAccordion">
                <t t-foreach="chapters" t-as="chapter" t-key="chapter.id">
                    <div class="accordion-item border">
                        <!-- Chapter Header -->
                        <h2 class="accordion-header">
                            <button class="accordion-button" 
                                    t-att-class="isChapterCollapsed(chapter.name) ? 'collapsed' : ''"
                                    type="button" 
                                    t-on-click="() => this.toggleChapter(chapter.name)">
                                <i class="fa fa-folder me-2 text-warning"/> 
                                <span t-esc="chapter.name"/>
                                <span class="badge bg-secondary ms-auto me-2">
                                    Total: <span t-esc="formatCurrency(chapter.data.total || 0)"/>
                                </span>
                            </button>
                        </h2>
                        
                        <!-- Chapter Content -->
                        <div t-if="!isChapterCollapsed(chapter.name)" class="accordion-collapse collapse show">
                            <div class="accordion-body p-0">
                                <t t-foreach="getSections(chapter.data)" t-as="section" t-key="section.name">
                                    <div class="border-bottom">
                                        <!-- Sección especial para Condiciones Particulares -->
                                        <t t-if="section.name.toLowerCase().includes('condiciones particulares')">
                                            <!-- Section Header para Condiciones Particulares -->
                                            <div class="d-flex justify-content-between align-items-center p-3 bg-light">
                                                <div class="d-flex align-items-center">
                                                    <i class="fa fa-file-text me-2 text-warning"/> 
                                                    <strong t-esc="section.name"/>
                                                </div>
                                                <small class="text-muted">Solo texto editable</small>
                                            </div>
                                            
                                            <!-- Área de texto editable para Condiciones Particulares -->
                                            <div class="p-3">
                                                <label t-att-for="'condiciones-particulares-' + chapter.name + '-' + section.name" class="form-label visually-hidden">Condiciones Particulares</label>
                                                <textarea t-att-id="'condiciones-particulares-' + chapter.name + '-' + section.name"
                                                         t-att-name="'condiciones-particulares-' + chapter.name + '-' + section.name"
                                                         class="form-control" 
                                                         rows="4" 
                                                         placeholder="Escriba aquí las condiciones particulares de esta sección..."
                                                         t-on-input="(ev) => this.updateCondicionesParticulares(chapter.name, section.name, ev.target.value)"
                                                         t-att-value="this.getCondicionesParticulares(chapter.name, section.name)"></textarea>
                                            </div>
                                        </t>
                                        
                                        <!-- Secciones normales con productos -->
                                        <t t-else="">
                                            <!-- Section Header -->
                                            <div class="d-flex justify-content-between align-items-center p-3 bg-light">
                                                <div class="d-flex align-items-center">
                                                    <i class="fa fa-wrench me-2 text-info"/> 
                                                    <strong t-esc="section.name"/>
                                                </div>
                                                <button class="btn btn-sm btn-outline-success" 
                                                        t-on-click="() => this.addProductToSection(chapter.name, section.name)"
                                                        title="Añadir producto a esta sección">
                                                    <i class="fa fa-plus me-1"/> Añadir Producto
                                                </button>
                                            </div>
                                            
                                            <!-- Section Lines con tabla nativa de Odoo -->
                                            <div class="table-responsive">
                                                <table class="table table-sm table-hover mb-0">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th class="text-start">PRODUCTO</th>
                                                            <th class="text-center">CANTIDAD</th>
                                                            <th class="text-end">PRECIO</th>
                                                            <th class="text-end">SUBTOTAL</th>
                                                            <th class="text-center">ACCIONES</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <t t-foreach="section.lines" t-as="line" t-key="line.id">
                                                            <tr>
                                                                <td class="align-middle">
                                                                    <t t-if="state.editingLine === line.id">
                                                                        <label t-att-for="'product-name-' + line.id" class="form-label visually-hidden">Nombre del Producto</label>
                                                                        <input type="text" 
                                                                               t-att-id="'product-name-' + line.id"
                                                                               t-att-name="'product-name-' + line.id"
                                                                               class="form-control form-control-sm" 
                                                                               t-att-value="state.editValues.name || ''"
                                                                               t-on-input="(ev) => this.updateEditValue('name', ev.target.value)"/>
                                                                    </t>
                                                                    <t t-else="">
                                                                        <span t-esc="line.product_id?.[1] || line.name || ''"/>
                                                                    </t>
                                                                </td>
                                                                
                                                                <td class="text-center align-middle">
                                                    <t t-if="state.editingLine === line.id">
                                                        <div class="input-group input-group-sm">
                                                            <label t-att-for="'quantity-' + line.id" class="form-label visually-hidden">Cantidad</label>
                                                            <input type="number" 
                                                                   t-att-id="'quantity-' + line.id"
                                                                   t-att-name="'quantity-' + line.id"
                                                                   class="form-control" 
                                                                   t-att-value="state.editValues.product_uom_qty || 0"
                                                                   t-on-input="(ev) => this.updateEditValue('product_uom_qty', ev.target.value)"
                                                                   step="0.01" 
                                                                   min="0"
                                                                   placeholder="Cantidad"/>
                                                            <span class="input-group-text" t-if="line.product_uom">
                                                                <small t-esc="line.product_uom[1]"/>
                                                            </span>
                                                        </div>
                                                    </t>
                                                    <t t-else="">
                                                        <span t-esc="line.product_uom_qty || 0"/>
                                                        <small class="text-muted d-block" t-if="line.product_uom">
                                                            <t t-esc="line.product_uom[1]"/>
                                                        </small>
                                                    </t>
                                                </td>
                                                                
                                                                <td class="text-end align-middle">
                                                    <t t-if="state.editingLine === line.id">
                                                        <div class="input-group input-group-sm">
                                                            <span class="input-group-text">$</span>
                                                            <label t-att-for="'price-' + line.id" class="form-label visually-hidden">Precio Unitario</label>
                                                            <input type="number" 
                                                                   t-att-id="'price-' + line.id"
                                                                   t-att-name="'price-' + line.id"
                                                                   class="form-control text-end" 
                                                                   t-att-value="state.editValues.price_unit || 0"
                                                                   t-on-input="(ev) => this.updateEditValue('price_unit', ev.target.value)"
                                                                   step="0.01" 
                                                                   min="0"
                                                                   placeholder="0.00"/>
                                                        </div>
                                                    </t>
                                                    <t t-else="">
                                                        <span class="fw-bold">$<t t-esc="(line.price_unit || 0).toFixed(2)"/></span>
                                                    </t>
                                                </td>
                                                                
                                                                <td class="text-end align-middle">
                                                    <span class="fw-bold text-primary">$<t t-esc="((line.product_uom_qty || 0) * (line.price_unit || 0)).toFixed(2)"/></span>
                                                </td>
                                                                
                                                                <td class="text-center align-middle">
                                                    <t t-if="state.editingLine === line.id">
                                                        <div class="btn-group" role="group">
                                                            <button class="btn btn-success btn-sm" 
                                                                    t-on-click="() => this.saveEdit()"
                                                                    title="Guardar cambios">
                                                                <i class="fa fa-check"/>
                                                            </button>
                                                            <button class="btn btn-secondary btn-sm" 
                                                                    t-on-click="() => this.cancelEdit()"
                                                                    title="Cancelar">
                                                                <i class="fa fa-times"/>
                                                            </button>
                                                        </div>
                                                    </t>
                                                    <t t-else="">
                                                        <div class="btn-group" role="group">
                                                            <button class="btn btn-outline-primary btn-sm" 
                                                                    t-on-click="() => this.startEditLine(line.id)"
                                                                    title="Editar línea">
                                                                <i class="fa fa-edit"/>
                                                            </button>
                                                            <button class="btn btn-outline-danger btn-sm" 
                                                                    t-on-click="() => this.deleteLine(line.id)"
                                                                    title="Eliminar línea">
                                                                <i class="fa fa-trash"/>
                                                            </button>
                                                        </div>
                                                    </t>
                                                </td>
                                                            </tr>
                                                        </t>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </t>
                                    </div>
                                </t>
                            </div>
                        </div>
                    </div>
                </t>
            </div>
        </div>
    </t>


<!-- Template para el diálogo de selección de productos -->
        <t t-name="capitulos.ProductSelectorDialog" owl="1">
            <Dialog size="'lg'" title="props.title">
                <div class="product-selector-dialog">
                    <div class="mb-3">
                        <label for="product-search-input" class="form-label">Buscar producto:</label>
                        <input 
                            type="text" 
                            id="product-search-input"
                            name="product-search-input"
                            class="form-control" 
                            placeholder="Escriba el nombre del producto..."
                            t-model="state.searchTerm"
                            t-on-input="onSearchInput"
                        />
                    </div>
                    
                    <div class="product-list" style="max-height: 400px; overflow-y: auto;">
                        <div t-if="state.loading" class="text-center p-3">
                            <i class="fa fa-spinner fa-spin"></i> Buscando productos...
                        </div>
                        
                        <div t-if="!state.loading and state.products.length === 0 and state.searchTerm" class="text-center p-3 text-muted">
                            No se encontraron productos
                        </div>
                        
                        <div t-if="!state.loading and !state.searchTerm" class="text-center p-3 text-muted">
                            Escriba para buscar productos
                        </div>
                        
                        <div t-foreach="state.products" t-as="product" t-key="product.id" 
                             class="product-item p-2 border-bottom" 
                             t-att-class="{'bg-primary text-white': state.selectedProduct and state.selectedProduct.id === product.id}"
                             t-on-click="() => this.selectProduct(product)"
                             style="cursor: pointer;">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong t-esc="product.name"></strong>
                                    <div t-if="product.default_code" class="small text-muted">
                                        Código: <span t-esc="product.default_code"></span>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-secondary" t-esc="product.list_price"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <t t-set-slot="footer">
                    <button type="button" class="btn btn-secondary" t-on-click="onCancel">Cancelar</button>
                    <button type="button" class="btn btn-primary" t-on-click="onConfirm" 
                            t-att-disabled="!state.selectedProduct">Confirmar</button>
                </t>
            </Dialog>
         </t>

        <!-- Template para el diálogo de confirmación de eliminación -->
        <t t-name="capitulos.DeleteConfirmDialog" owl="1">
            <Dialog size="'md'" title="props.title">
                <div class="delete-confirm-dialog">
                    <div class="mb-3">
                        <div class="d-flex align-items-center mb-3">
                            <i class="fa fa-exclamation-triangle text-warning me-3" style="font-size: 2em;"></i>
                            <div>
                                <p class="mb-1">¿Está seguro de que desea eliminar el producto:</p>
                                <strong t-esc="props.productName"></strong>
                            </div>
                        </div>
                        <div class="alert alert-warning mb-0">
                            <i class="fa fa-info-circle me-2"></i>
                            Esta acción no se puede deshacer.
                        </div>
                    </div>
                </div>
                
                <t t-set-slot="footer">
                    <button type="button" class="btn btn-secondary" t-on-click="onCancel">
                        <i class="fa fa-times me-1"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-danger" t-on-click="onConfirm">
                        <i class="fa fa-trash me-1"></i> Eliminar
                    </button>
                </t>
            </Dialog>
        </t>
     </templates>