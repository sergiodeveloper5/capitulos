<?xml version="1.0" encoding="utf-8"?>
<!--
==========================================
PLANTILLAS XML PARA WIDGET DE CAPÍTULOS
==========================================

@file capitulos_accordion_templates.xml
@description Plantillas QWeb para el widget de acordeón de capítulos técnicos
@author Sergio Vadillo
@version 18.0.1.1.0
@since 2024

@overview
Este archivo contiene todas las plantillas QWeb necesarias para renderizar
el widget CapitulosAccordionWidget, incluyendo:

- Plantilla principal del widget de acordeón
- Plantillas de diálogos modales (selección de productos, confirmación)
- Estructuras de tablas y formularios inline
- Elementos de navegación y controles de usuario

@dependencies
- QWeb Template Engine (Odoo)
- Bootstrap 5.x (para clases CSS)
- Font Awesome (para iconografía)

@usage
Las plantillas se referencian desde el componente JavaScript:
- CapitulosAccordionWidget.template = "capitulos.CapitulosAccordionWidget"
- ProductSelectorDialog.template = "capitulos.ProductSelectorDialog"
- DeleteConfirmDialog.template = "capitulos.DeleteConfirmDialog"
-->

<templates xml:space="preserve">

    <!-- ==========================================
         PLANTILLA PRINCIPAL DEL WIDGET
         ========================================== -->
    
    <!--
    Plantilla principal del widget de acordeón de capítulos técnicos.
    
    @template capitulos.CapitulosAccordionWidget
    @description Renderiza la estructura completa del widget incluyendo:
                 - Encabezado con información del pedido
                 - Acordeón de capítulos expandibles/colapsables
                 - Secciones con tablas de productos
                 - Controles de edición inline
                 - Área de condiciones particulares
    
    @context {Object} this - Instancia del widget CapitulosAccordionWidget
    @context {Object} this.parsedData - Datos parseados de capítulos y secciones
    @context {Object} this.state - Estado reactivo del componente
    
    @example
    <field name="capitulos_data" widget="capitulos_accordion"/>
    -->
    <t t-name="capitulos.CapitulosAccordionWidget">
        <div class="o_field_widget">
            <!-- Encabezado del widget con información general -->
            <div class="widget-header">
                <h4 class="mb-0">
                    <i class="fa fa-list-alt me-2"></i>
                    Capítulos Técnicos
                </h4>
                <small class="opacity-75">Gestión de productos por capítulos y secciones</small>
            </div>

            <!-- Contenedor principal del acordeón -->
            <!-- 
            Estructura del acordeón que contiene todos los capítulos.
            Cada capítulo puede expandirse/colapsarse independientemente.
            -->
            <div class="accordion" id="capitulosAccordion">
                <t t-foreach="chapters" t-as="chapter" t-key="chapter.id">
                    <!-- 
                    Elemento individual del acordeón para cada capítulo.
                    Incluye encabezado clickeable y contenido colapsable.
                    -->
                    <div class="accordion-item">
                        <!-- Encabezado del capítulo con botón de expansión/colapso -->
                        <h2 class="accordion-header" t-attf-id="heading-{{chapter.id}}">
                            <button class="accordion-button" 
                                    t-attf-class="accordion-button {{ 'collapsed' if isChapterCollapsed(chapter.name) else '' }}"
                                    type="button" 
                                    t-on-click="() => this.toggleChapter(chapter.name)"
                                    t-attf-aria-expanded="{{ 'false' if isChapterCollapsed(chapter.name) else 'true' }}"
                                    t-attf-aria-controls="collapse-{{chapter.id}}">
                                
                                <!-- Información del capítulo -->
                                <div class="d-flex justify-content-between align-items-center w-100 me-3">
                                    <div class="d-flex align-items-center">
                                        <i class="fa fa-folder-open me-2 text-primary"></i>
                                        <span class="fw-bold" t-esc="chapter.name"></span>
                                    </div>
                                    
                                    <!-- Badge con total del capítulo -->
                                    <span class="badge bg-primary ms-auto me-2">
                                        Total: <span t-esc="formatCurrency(chapter.total || 0)"></span>
                                    </span>
                                </div>
                            </button>
                        </h2>

                        <!-- Contenido colapsable del capítulo -->
                        <div t-attf-id="collapse-{{chapter.id}}" 
                             t-attf-class="accordion-collapse collapse {{ '' if isChapterCollapsed(chapter.name) else 'show' }}"
                             t-attf-aria-labelledby="heading-{{chapter.id}}"
                             data-bs-parent="#capitulosAccordion">
                            
                            <div class="accordion-body">
                                <!-- 
                                Iteración sobre las secciones del capítulo.
                                Cada sección puede contener productos o ser de condiciones particulares.
                                -->
                                <t t-foreach="getSections(chapter)" t-as="section" t-key="section_index">
                                    <div class="border-bottom">
                                        <!-- Sección especial para Condiciones Particulares -->
                                        <t t-if="section.name.toLowerCase().includes('condiciones particulares')">
                                            <!-- Section Header para Condiciones Particulares -->
                                            <div class="d-flex justify-content-between align-items-center p-3 bg-light">
                                                <div class="d-flex align-items-center">
                                                    <i class="fa fa-file-text me-2 text-warning"/> 
                                                    <strong t-esc="section.name"/>
                                                </div>
                                                <small class="text-muted">Solo texto editable</small>
                                            </div>
                                            
                                            <!-- Área de texto editable para Condiciones Particulares -->
                                            <div class="p-3">
                                                <label t-att-for="'condiciones-particulares-' + chapter.name + '-' + section.name" class="form-label visually-hidden">Condiciones Particulares</label>
                                                <textarea t-att-id="'condiciones-particulares-' + chapter.name + '-' + section.name"
                                                         t-att-name="'condiciones-particulares-' + chapter.name + '-' + section.name"
                                                         class="form-control" 
                                                         rows="4" 
                                                         placeholder="Escriba aquí las condiciones particulares de esta sección..."
                                                         t-on-input="(ev) => this.updateCondicionesParticulares(chapter.name, section.name, ev.target.value)"
                                                         t-att-value="this.getCondicionesParticulares(chapter.name, section.name)"></textarea>
                                            </div>
                                        </t>
                                        
                                        <!-- Secciones normales con productos -->
                                        <t t-else="">
                                            <!-- Section Header -->
                                            <div class="d-flex justify-content-between align-items-center p-3 bg-light">
                                                <div class="d-flex align-items-center">
                                                    <i class="fa fa-wrench me-2 text-info"/> 
                                                    <strong t-esc="section.name"/>
                                                </div>
                                                <button class="btn btn-sm btn-outline-success" 
                                                        t-on-click="() => this.addProductToSection(chapter.name, section.name)"
                                                        title="Añadir producto a esta sección">
                                                    <i class="fa fa-plus me-1"/> Añadir Producto
                                                </button>
                                            </div>
                                            
                                            <!-- Section Lines con tabla nativa de Odoo -->
                                            <div class="table-responsive">
                                                <table class="table table-sm table-hover mb-0">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th class="text-start">PRODUCTO</th>
                                                            <th class="text-center">CANTIDAD</th>
                                                            <th class="text-end">PRECIO</th>
                                                            <th class="text-end">SUBTOTAL</th>
                                                            <th class="text-center">ACCIONES</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <t t-foreach="section.lines" t-as="line" t-key="line.id">
                                                            <tr>
                                                                <td class="align-middle">
                                                                    <t t-if="state.editingLine === line.id">
                                                                        <label t-att-for="'product-name-' + line.id" class="form-label visually-hidden">Nombre del Producto</label>
                                                                        <input type="text" 
                                                                               t-att-id="'product-name-' + line.id"
                                                                               t-att-name="'product-name-' + line.id"
                                                                               class="form-control form-control-sm" 
                                                                               t-att-value="state.editValues.name || ''"
                                                                               t-on-input="(ev) => this.updateEditValue('name', ev.target.value)"/>
                                                                    </t>
                                                                    <t t-else="">
                                                                        <span t-esc="line.product_id?.[1] || line.name || ''"/>
                                                                    </t>
                                                                </td>
                                                                
                                                                <td class="text-center align-middle">
                                                    <t t-if="state.editingLine === line.id">
                                                        <div class="input-group input-group-sm">
                                                            <label t-att-for="'quantity-' + line.id" class="form-label visually-hidden">Cantidad</label>
                                                            <input type="number" 
                                                                   t-att-id="'quantity-' + line.id"
                                                                   t-att-name="'quantity-' + line.id"
                                                                   class="form-control" 
                                                                   t-att-value="state.editValues.product_uom_qty || 0"
                                                                   t-on-input="(ev) => this.updateEditValue('product_uom_qty', ev.target.value)"
                                                                   step="0.01" 
                                                                   min="0"
                                                                   placeholder="Cantidad"/>
                                                            <span class="input-group-text" t-if="line.product_uom">
                                                                <small t-esc="line.product_uom[1]"/>
                                                            </span>
                                                        </div>
                                                    </t>
                                                    <t t-else="">
                                                        <span t-esc="line.product_uom_qty || 0"/>
                                                        <small class="text-muted d-block" t-if="line.product_uom">
                                                            <t t-esc="line.product_uom[1]"/>
                                                        </small>
                                                    </t>
                                                </td>
                                                                
                                                                <td class="text-end align-middle">
                                                    <t t-if="state.editingLine === line.id">
                                                        <div class="input-group input-group-sm">
                                                            <span class="input-group-text">$</span>
                                                            <label t-att-for="'price-' + line.id" class="form-label visually-hidden">Precio Unitario</label>
                                                            <input type="number" 
                                                                   t-att-id="'price-' + line.id"
                                                                   t-att-name="'price-' + line.id"
                                                                   class="form-control text-end" 
                                                                   t-att-value="state.editValues.price_unit || 0"
                                                                   t-on-input="(ev) => this.updateEditValue('price_unit', ev.target.value)"
                                                                   step="0.01" 
                                                                   min="0"
                                                                   placeholder="0.00"/>
                                                        </div>
                                                    </t>
                                                    <t t-else="">
                                                        <span class="fw-bold">$<t t-esc="(line.price_unit || 0).toFixed(2)"/></span>
                                                    </t>
                                                </td>
                                                                
                                                                <td class="text-end align-middle">
                                                    <span class="fw-bold text-primary">$<t t-esc="((line.product_uom_qty || 0) * (line.price_unit || 0)).toFixed(2)"/></span>
                                                </td>
                                                                
                                                                <td class="text-center align-middle">
                                                    <t t-if="state.editingLine === line.id">
                                                        <div class="btn-group" role="group">
                                                            <button class="btn btn-success btn-sm" 
                                                                    t-on-click="() => this.saveEdit()"
                                                                    title="Guardar cambios">
                                                                <i class="fa fa-check"/>
                                                            </button>
                                                            <button class="btn btn-secondary btn-sm" 
                                                                    t-on-click="() => this.cancelEdit()"
                                                                    title="Cancelar">
                                                                <i class="fa fa-times"/>
                                                            </button>
                                                        </div>
                                                    </t>
                                                    <t t-else="">
                                                        <div class="btn-group" role="group">
                                                            <button class="btn btn-outline-primary btn-sm" 
                                                                    t-on-click="() => this.startEditLine(line.id)"
                                                                    title="Editar línea">
                                                                <i class="fa fa-edit"/>
                                                            </button>
                                                            <button class="btn btn-outline-danger btn-sm" 
                                                                    t-on-click="() => this.deleteLine(line.id)"
                                                                    title="Eliminar línea">
                                                                <i class="fa fa-trash"/>
                                                            </button>
                                                        </div>
                                                    </t>
                                                </td>
                                                            </tr>
                                                        </t>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </t>
                                    </div>
                                </t>
                            </div>
                        </div>
                    </div>
                </t>
            </div>
        </div>
    </t>


    <!-- ==========================================
         PLANTILLA DE DIÁLOGO DE SELECCIÓN DE PRODUCTOS
         ========================================== -->
    
    <!--
    Plantilla para el diálogo modal de selección de productos.
    
    @template capitulos.ProductSelectorDialog
    @description Diálogo de dos pasos para seleccionar productos:
                 1. Selección de categoría con búsqueda
                 2. Selección de producto específico
    
    @context {Object} this - Instancia del diálogo ProductSelectorDialog
    @context {Object} this.state - Estado reactivo del diálogo
    @context {string} this.state.step - Paso actual ('category' | 'product')
    @context {Array} this.state.categories - Lista de categorías disponibles
    @context {Array} this.state.products - Lista de productos disponibles
    
    @features
    - Búsqueda en tiempo real
    - Navegación entre pasos
    - Estados de carga
    - Validación de selección
    -->
    <t t-name="capitulos.ProductSelectorDialog" owl="1">
            <Dialog size="'lg'" title="props.title">
                <div class="product-selector-dialog">
                    <!-- Paso 1: Selección de Categoría -->
                    <div t-if="state.step === 'category'" class="category-selection">
                        <div class="alert alert-info mb-3">
                            <i class="fa fa-info-circle me-2"></i>
                            <strong>Paso 1:</strong> Seleccione una categoría de productos
                        </div>
                        
                        <div class="mb-3">
                            <label for="category-search-input" class="form-label">Buscar categoría:</label>
                            <input 
                                type="text" 
                                id="category-search-input"
                                name="category-search-input"
                                class="form-control" 
                                placeholder="Escriba el nombre de la categoría..."
                                t-model="state.categorySearchTerm"
                                t-on-input="onCategorySearchInput"
                            />
                        </div>
                        
                        <div class="category-list" style="max-height: 400px; overflow-y: auto;">
                            <div t-if="state.loadingCategories" class="text-center p-3">
                                <i class="fa fa-spinner fa-spin"></i> Cargando categorías...
                            </div>
                            
                            <div t-if="!state.loadingCategories and state.categories.length === 0 and state.categorySearchTerm" class="text-center p-3 text-muted">
                                <i class="fa fa-search me-2"></i>
                                No se encontraron categorías que coincidan con "<strong t-esc="state.categorySearchTerm"/>"
                            </div>
                            
                            <div t-if="!state.loadingCategories and !state.categorySearchTerm" class="text-center p-3 text-muted">
                                <i class="fa fa-keyboard-o me-2"></i>
                                Escriba para buscar categorías o seleccione una de la lista
                            </div>
                            
                            <div t-foreach="state.categories" t-as="category" t-key="category.id" 
                                 class="category-item p-3 border-bottom" 
                                 t-att-class="{'bg-primary text-white': state.selectedCategory and state.selectedCategory.id === category.id, 'border-primary': state.selectedCategory and state.selectedCategory.id === category.id}"
                                 t-on-click="() => this.selectCategory(category)"
                                 style="cursor: pointer; transition: all 0.2s;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center mb-1">
                                            <i class="fa fa-folder me-2"></i>
                                            <strong t-esc="category.name" class="me-2"></strong>
                                            <span t-if="state.selectedCategory and state.selectedCategory.id === category.id" 
                                                  class="badge bg-light text-primary">
                                                <i class="fa fa-check"></i> Seleccionada
                                            </span>
                                        </div>
                                        <div t-if="category.parent_id" class="small" 
                                             t-att-class="state.selectedCategory and state.selectedCategory.id === category.id ? 'text-light' : 'text-muted'">
                                            <i class="fa fa-level-up me-1"></i>
                                            Categoría padre: <span t-esc="category.parent_id[1]"></span>
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <span t-if="category.product_count" class="badge bg-secondary">
                                            <span t-esc="category.product_count"></span> productos
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Paso 2: Selección de Producto -->
                    <div t-if="state.step === 'product'" class="product-selection">
                        <div class="alert alert-success mb-3">
                            <i class="fa fa-check-circle me-2"></i>
                            <strong>Paso 2:</strong> Seleccione un producto de la categoría 
                            "<span t-esc="state.selectedCategory.name"/>"
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" 
                                    t-on-click="goBackToCategories">
                                <i class="fa fa-arrow-left me-1"></i> Cambiar categoría
                            </button>
                        </div>
                        
                        <div class="mb-3">
                            <label for="product-search-input" class="form-label">Buscar producto:</label>
                            <input 
                                type="text" 
                                id="product-search-input"
                                name="product-search-input"
                                class="form-control" 
                                placeholder="Escriba el nombre del producto..."
                                t-model="state.productSearchTerm"
                                t-on-input="onProductSearchInput"
                            />
                        </div>
                        
                        <div class="product-list" style="max-height: 400px; overflow-y: auto;">
                            <div t-if="state.loadingProducts" class="text-center p-3">
                                <i class="fa fa-spinner fa-spin"></i> Cargando productos...
                            </div>
                            
                            <div t-if="!state.loadingProducts and state.products.length === 0 and state.productSearchTerm" class="text-center p-3 text-muted">
                                <i class="fa fa-search me-2"></i>
                                No se encontraron productos que coincidan con "<strong t-esc="state.productSearchTerm"/>"
                                en la categoría "<span t-esc="state.selectedCategory.name"/>"
                            </div>
                            
                            <div t-if="!state.loadingProducts and !state.productSearchTerm" class="text-center p-3 text-muted">
                                <i class="fa fa-keyboard-o me-2"></i>
                                Escriba para buscar productos en la categoría "<span t-esc="state.selectedCategory.name"/>"
                            </div>
                            
                            <div t-foreach="state.products" t-as="product" t-key="product.id" 
                                 class="product-item p-3 border-bottom" 
                                 t-att-class="{'bg-primary text-white': state.selectedProduct and state.selectedProduct.id === product.id, 'border-primary': state.selectedProduct and state.selectedProduct.id === product.id}"
                                 t-on-click="() => this.selectProduct(product)"
                                 style="cursor: pointer; transition: all 0.2s;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center mb-1">
                                            <strong t-esc="product.name" class="me-2"></strong>
                                            <span t-if="state.selectedProduct and state.selectedProduct.id === product.id" 
                                                  class="badge bg-light text-primary">
                                                <i class="fa fa-check"></i> Seleccionado
                                            </span>
                                        </div>
                                        <div t-if="product.default_code" class="small" 
                                             t-att-class="state.selectedProduct and state.selectedProduct.id === product.id ? 'text-light' : 'text-muted'">
                                            <i class="fa fa-barcode me-1"></i>
                                            Código: <span t-esc="product.default_code"></span>
                                        </div>
                                        <div t-if="product.categ_id" class="small" 
                                             t-att-class="state.selectedProduct and state.selectedProduct.id === product.id ? 'text-light' : 'text-muted'">
                                            <i class="fa fa-folder me-1"></i>
                                            Categoría: <span t-esc="product.categ_id[1]"></span>
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <div class="fw-bold mb-1">
                                            <span t-att-class="state.selectedProduct and state.selectedProduct.id === product.id ? 'text-light' : 'text-success'">
                                                $<span t-esc="(product.list_price || 0).toFixed(2)"></span>
                                            </span>
                                        </div>
                                        <div t-if="product.uom_id" class="small" 
                                             t-att-class="state.selectedProduct and state.selectedProduct.id === product.id ? 'text-light' : 'text-muted'">
                                            <span t-esc="product.uom_id[1]"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <t t-set-slot="footer">
                    <button type="button" class="btn btn-secondary" t-on-click="onCancel">
                        <i class="fa fa-times me-1"></i> Cancelar
                    </button>
                    <button t-if="state.step === 'category'" type="button" class="btn btn-primary" 
                            t-on-click="proceedToProducts" 
                            t-att-disabled="!state.selectedCategory">
                        <i class="fa fa-arrow-right me-1"></i> Continuar
                    </button>
                    <button t-if="state.step === 'product'" type="button" class="btn btn-primary" 
                            t-on-click="onConfirm" 
                            t-att-disabled="!state.selectedProduct">
                        <i class="fa fa-check me-1"></i> Confirmar
                    </button>
                </t>
            </Dialog>
         </t>

    <!-- ==========================================
         PLANTILLA DE DIÁLOGO DE CONFIRMACIÓN
         ========================================== -->
    
    <!--
    Plantilla para el diálogo de confirmación de eliminación.
    
    @template capitulos.DeleteConfirmDialog
    @description Diálogo modal que solicita confirmación antes de eliminar
                 una línea de producto del presupuesto.
    
    @context {Object} this - Instancia del diálogo DeleteConfirmDialog
    @context {Object} this.props - Propiedades del diálogo
    @context {string} this.props.title - Título del diálogo
    @context {string} this.props.productName - Nombre del producto a eliminar
    @context {Function} this.props.onConfirm - Callback de confirmación
    @context {Function} this.props.onCancel - Callback de cancelación
    
    @features
    - Mensaje de confirmación claro
    - Información del producto a eliminar
    - Botones de acción diferenciados
    - Integración con sistema de diálogos de Odoo
    -->
    <t t-name="capitulos.DeleteConfirmDialog" owl="1">
            <Dialog size="'md'" title="props.title">
                <div class="delete-confirm-dialog">
                    <div class="mb-3">
                        <div class="d-flex align-items-center mb-3">
                            <i class="fa fa-exclamation-triangle text-warning me-3" style="font-size: 2em;"></i>
                            <div>
                                <p class="mb-1">¿Está seguro de que desea eliminar el producto:</p>
                                <strong t-esc="props.productName"></strong>
                            </div>
                        </div>
                        <div class="alert alert-warning mb-0">
                            <i class="fa fa-info-circle me-2"></i>
                            Esta acción no se puede deshacer.
                        </div>
                    </div>
                </div>
                
                <t t-set-slot="footer">
                    <button type="button" class="btn btn-secondary" t-on-click="onCancel">
                        <i class="fa fa-times me-1"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-danger" t-on-click="onConfirm">
                        <i class="fa fa-trash me-1"></i> Eliminar
                    </button>
                </t>
            </Dialog>
        </t>
     </templates>