<!-- 
VISTAS XML PARA EL WIZARD DE CAPÍTULOS TÉCNICOS
==============================================

Este archivo define la vista del wizard para gestionar capítulos técnicos,
permitiendo crear capítulos nuevos o seleccionar existentes, gestionar
secciones y productos, y añadir todo al pedido de venta.

FUNCIONALIDADES DEL WIZARD:
- Selección entre capítulo existente o nuevo
- Gestión dinámica de secciones y productos
- Validación de categorías de productos
- Integración con pedidos de venta
- Interfaz intuitiva con campos condicionales

COMPONENTES PRINCIPALES:
- Formulario principal del wizard
- Gestión de secciones con productos
- Validaciones en tiempo real
- Botones de acción contextuales

@author: Sergio Vadillo
@version: 18.0.1.1.0
@since: 2024
@license: LGPL-3
-->

<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        
        <!-- ========================================== -->
        <!-- VISTA DE FORMULARIO DEL WIZARD            -->
        <!-- ========================================== -->
        
        <!-- 
        Vista principal del wizard para gestionar capítulos técnicos.
        Permite seleccionar entre capítulo existente o crear uno nuevo,
        gestionar secciones y productos, y añadir todo al pedido de venta.
        -->
        <record id="view_capitulo_wizard_form" model="ir.ui.view">
            <field name="name">capitulo.wizard.form</field>
            <field name="model">capitulo.wizard</field>
            <field name="arch" type="xml">
                <form string="Gestión de Capítulos Técnicos">
                    
                    <!-- Contenido principal del wizard -->
                    <sheet>
                        
                        <!-- Título del wizard -->
                        <div class="oe_title">
                            <h1>
                                <field name="sale_order_id" invisible="1"/>
                                Gestión de Capítulos Técnicos
                            </h1>
                            <p class="text-muted">
                                Selecciona un capítulo existente o crea uno nuevo para añadir al presupuesto
                            </p>
                        </div>
                        
                        <!-- Separador visual -->
                        <div class="o_horizontal_separator mt16 mb16">Configuración del Capítulo</div>
                        
                        <!-- Selección del modo de creación -->
                        <group name="creation_mode">
                            <group name="mode_selection" string="Modo de Creación">
                                <!-- Selector de modo: existente o nuevo -->
                                <field name="creation_mode" 
                                       widget="radio" 
                                       options="{'horizontal': true}"
                                       help="Selecciona si quieres usar un capítulo existente o crear uno nuevo"/>
                            </group>
                        </group>
                        
                        <!-- Campos condicionales según el modo seleccionado -->
                        <group name="chapter_selection">
                            
                            <!-- Modo: Capítulo Existente -->
                            <group name="existing_chapter" 
                                   string="Capítulo Existente" 
                                   invisible="creation_mode != 'existing'">
                                
                                <!-- Selector de capítulo existente -->
                                <field name="existing_capitulo_id" 
                                       string="Seleccionar Capítulo"
                                       domain="[('es_plantilla', '=', False)]"
                                       required="creation_mode == 'existing'"
                                       options="{'no_create': True, 'no_edit': True}"
                                       help="Selecciona un capítulo existente para añadir al presupuesto"/>
                            </group>
                            
                            <!-- Modo: Nuevo Capítulo -->
                            <group name="new_chapter" 
                                   string="Nuevo Capítulo" 
                                   invisible="creation_mode != 'new'">
                                
                                <!-- Nombre del nuevo capítulo -->
                                <field name="new_capitulo_name" 
                                       string="Nombre del Capítulo"
                                       required="creation_mode == 'new'"
                                       placeholder="Introduce el nombre del nuevo capítulo..."
                                       help="Nombre descriptivo para el nuevo capítulo"/>
                                
                                <!-- Descripción del nuevo capítulo -->
                                <field name="new_capitulo_description" 
                                       string="Descripción"
                                       placeholder="Descripción detallada del capítulo..."
                                       help="Descripción completa del nuevo capítulo"/>
                                
                                <!-- Plantilla base (opcional) -->
                                <field name="plantilla_id" 
                                       string="Basado en Plantilla"
                                       domain="[('es_plantilla', '=', True)]"
                                       options="{'no_create': True}"
                                       help="Opcionalmente, selecciona una plantilla como base"/>
                            </group>
                        </group>
                        
                        <!-- Separador para secciones -->
                        <div class="o_horizontal_separator mt16 mb16">Gestión de Secciones y Productos</div>
                        
                        <!-- Gestión de secciones y productos -->
                        <notebook>
                            <page string="Secciones y Productos" name="secciones_productos">
                                
                                <!-- Lista de secciones del wizard -->
                                <field name="seccion_ids" 
                                       context="{'default_wizard_id': active_id}"
                                       help="Secciones disponibles para este capítulo">
                                    
                                    <!-- Vista de árbol para secciones -->
                                    <tree string="Secciones del Capítulo" 
                                          editable="bottom" 
                                          decoration-success="incluir"
                                          decoration-muted="not incluir">
                                        
                                        <!-- Checkbox para incluir la sección -->
                                        <field name="incluir" 
                                               string="Incluir"
                                               widget="boolean_toggle"
                                               help="Marca para incluir esta sección en el presupuesto"/>
                                        
                                        <!-- Nombre de la sección -->
                                        <field name="name" 
                                               string="Nombre de Sección"
                                               required="1"
                                               help="Nombre descriptivo de la sección"/>
                                        
                                        <!-- Orden de la sección -->
                                        <field name="sequence" 
                                               string="Orden"
                                               help="Orden de aparición en el presupuesto"/>
                                        
                                        <!-- Indicador de sección fija -->
                                        <field name="es_fija" 
                                               string="Fija"
                                               readonly="1"
                                               help="Las secciones fijas no pueden ser modificadas"/>
                                        
                                        <!-- Categoría de productos -->
                                        <field name="product_category_id" 
                                               string="Categoría de Productos"
                                               help="Categoría de productos permitidos en esta sección"/>
                                    </tree>
                                    
                                    <!-- Vista de formulario para secciones -->
                                    <form string="Configuración de Sección">
                                        
                                        <!-- Información básica de la sección -->
                                        <group>
                                            <group name="section_basic" string="Información Básica">
                                                <field name="incluir" 
                                                       widget="boolean_toggle"
                                                       help="Incluir esta sección en el presupuesto"/>
                                                <field name="name" required="1"/>
                                                <field name="sequence"/>
                                                <field name="es_fija" readonly="1"/>
                                            </group>
                                            
                                            <group name="section_category" string="Configuración de Productos">
                                                <field name="product_category_id" 
                                                       help="Selecciona la categoría de productos permitidos"/>
                                            </group>
                                        </group>
                                        
                                        <!-- Productos de la sección -->
                                        <notebook>
                                            <page string="Productos" name="productos_seccion">
                                                
                                                <!-- Mensaje informativo sobre categoría -->
                                                <div class="alert alert-info" 
                                                     role="alert" 
                                                     invisible="product_category_id">
                                                    <strong>Información:</strong> 
                                                    Selecciona una categoría de productos para filtrar los productos disponibles.
                                                </div>
                                                
                                                <!-- Lista de productos de la sección -->
                                                <field name="line_ids" 
                                                       context="{'default_seccion_id': active_id}"
                                                       help="Productos incluidos en esta sección">
                                                    
                                                    <!-- Vista de árbol para productos -->
                                                    <tree string="Productos de la Sección" 
                                                          editable="bottom"
                                                          decoration-success="incluir"
                                                          decoration-muted="not incluir">
                                                        
                                                        <!-- Checkbox para incluir el producto -->
                                                        <field name="incluir" 
                                                               string="Incluir"
                                                               widget="boolean_toggle"
                                                               help="Incluir este producto en el presupuesto"/>
                                                        
                                                        <!-- Producto -->
                                                        <field name="product_id" 
                                                               string="Producto"
                                                               required="1"
                                                               domain="[('sale_ok', '=', True)] if not parent.product_category_id else [('sale_ok', '=', True), ('categ_id', 'child_of', parent.product_category_id)]"
                                                               help="Selecciona el producto"/>
                                                        
                                                        <!-- Descripción personalizada -->
                                                        <field name="descripcion_personalizada" 
                                                               string="Descripción Personalizada"
                                                               help="Descripción específica para este presupuesto"/>
                                                        
                                                        <!-- Cantidad -->
                                                        <field name="cantidad" 
                                                               string="Cantidad"
                                                               required="1"
                                                               help="Cantidad del producto"/>
                                                        
                                                        <!-- Precio unitario -->
                                                        <field name="precio_unitario" 
                                                               string="Precio Unitario"
                                                               help="Precio unitario del producto"/>
                                                        
                                                        <!-- Indicador de producto opcional -->
                                                        <field name="es_opcional" 
                                                               string="Opcional"
                                                               help="Marca si este producto es opcional"/>
                                                    </tree>
                                                    
                                                    <!-- Vista de formulario para productos -->
                                                    <form string="Configuración de Producto">
                                                        <group>
                                                            <group name="product_basic" string="Información del Producto">
                                                                <field name="incluir" widget="boolean_toggle"/>
                                                                <field name="product_id" required="1"/>
                                                                <field name="descripcion_personalizada"/>
                                                                <field name="es_opcional"/>
                                                            </group>
                                                            
                                                            <group name="product_pricing" string="Precios y Cantidades">
                                                                <field name="cantidad" required="1"/>
                                                                <field name="precio_unitario"/>
                                                            </group>
                                                        </group>
                                                    </form>
                                                </field>
                                            </page>
                                        </notebook>
                                    </form>
                                </field>
                            </page>
                            
                            <!-- Pestaña de condiciones particulares -->
                            <page string="Condiciones Particulares" name="condiciones">
                                <field name="condiciones_particulares" 
                                       placeholder="Condiciones específicas para este presupuesto..."
                                       help="Condiciones particulares que se aplicarán a este capítulo en el presupuesto"/>
                            </page>
                        </notebook>
                    </sheet>
                    
                    <!-- Botones de acción del wizard -->
                    <footer>
                        <div class="d-flex justify-content-between">
                            
                            <!-- Botones principales -->
                            <div>
                                <!-- Botón para añadir al presupuesto -->
                                <button name="add_to_order" 
                                        type="object" 
                                        string="Añadir al Presupuesto" 
                                        class="btn-primary"
                                        help="Añade el capítulo configurado al pedido de venta"/>
                                
                                <!-- Botón para añadir sección -->
                                <button name="add_seccion" 
                                        type="object" 
                                        string="Añadir Sección" 
                                        class="btn-secondary"
                                        help="Añade una nueva sección al capítulo"/>
                            </div>
                            
                            <!-- Botones secundarios -->
                            <div>
                                <!-- Botón para añadir otro capítulo -->
                                <button name="add_another_chapter" 
                                        type="object" 
                                        string="Añadir Otro Capítulo" 
                                        class="btn-link"
                                        help="Añade este capítulo y permite configurar otro"/>
                                
                                <!-- Botón para cancelar -->
                                <button string="Cancelar" 
                                        class="btn-secondary" 
                                        special="cancel"
                                        help="Cancela la operación sin guardar cambios"/>
                            </div>
                        </div>
                    </footer>
                </form>
            </field>
        </record>

        <!-- ========================================== -->
        <!-- ACCIÓN DEL WIZARD                          -->
        <!-- ========================================== -->
        
        <!-- 
        Acción para abrir el wizard de gestión de capítulos.
        Se utiliza desde los pedidos de venta para añadir capítulos.
        -->
        <record id="action_capitulo_wizard" model="ir.actions.act_window">
            <field name="name">Gestión de Capítulos Técnicos</field>
            <field name="res_model">capitulo.wizard</field>
            <field name="view_mode">form</field>
            <field name="target">new</field>
            <field name="context">{
                'default_sale_order_id': active_id,
                'default_creation_mode': 'existing'
            }</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    ¡Configura tu capítulo técnico!
                </p>
                <p>
                    Este wizard te permite añadir capítulos técnicos estructurados
                    a tu pedido de venta de forma rápida y organizada.
                </p>
                <p>
                    <strong>Opciones disponibles:</strong>
                </p>
                <ul>
                    <li>Seleccionar un capítulo existente</li>
                    <li>Crear un nuevo capítulo desde cero</li>
                    <li>Usar una plantilla como base</li>
                    <li>Configurar secciones y productos</li>
                </ul>
            </field>
        </record>

    </data>
</odoo>