<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Extensión de vistas de pedidos de venta para capítulos técnicos -->
    <record id="view_order_form_inherit_capitulo" model="ir.ui.view">
        <field name="name">sale.order.form.inherit.capitulo</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="arch" type="xml">
            <!-- Botón de gestión de capítulos -->
            <xpath expr="//button[@name='action_quotation_send']" position="after">
                <button name="action_add_capitulo" string="Gestionar Capítulos" type="object" 
                        class="btn-secondary" groups="sales_team.group_sale_salesman" 
                        invisible="state not in ['draft', 'sent']"/>
            </xpath>
            
            <!-- Vista de acordeón antes del campo order_line -->
            <xpath expr="//field[@name='order_line']" position="before">
                <div class="capitulos-container" invisible="not tiene_multiples_capitulos">
                    <h4 style="margin-bottom: 15px; color: #007bff;">📋 Capítulos del Presupuesto</h4>
                    <field name="capitulos_agrupados" widget="capitulos_accordion" nolabel="1"/>
                </div>
            </xpath>
            
            <!-- Ocultar vista tradicional cuando hay capítulos (mantiene compatibilidad PDF) -->
            <xpath expr="//field[@name='order_line']" position="attributes">
                <attribute name="invisible">tiene_multiples_capitulos</attribute>
            </xpath>
            
            <!-- Campos de control -->
            <xpath expr="//field[@name='order_line']" position="after">
                <field name="capitulo_ids" invisible="not capitulo_ids" widget="many2many_tags"/>
                <field name="tiene_multiples_capitulos" invisible="1"/>
            </xpath>
        </field>
    </record>

</odoo>