<?xml version="1.0" encoding="utf-8"?>
<!--
    ARCHIVO: sale_order_views.xml
    PROP칍SITO: Extensi칩n de vistas de pedidos de venta para integraci칩n con cap칤tulos t칠cnicos
    
    FUNCIONALIDAD PRINCIPAL:
    - Hereda y modifica la vista est치ndar de pedidos de venta de Odoo
    - A침ade funcionalidad de gesti칩n de cap칤tulos t칠cnicos
    - Implementa visualizaci칩n dual: acorde칩n para cap칤tulos estructurados y vista tradicional
    - Integra bot칩n de acceso al wizard de gesti칩n de cap칤tulos
    
    MODIFICACIONES REALIZADAS:
    1. Bot칩n "Gestionar Cap칤tulos" en la barra de herramientas
    2. Reemplazo del campo order_line con contenedor dual
    3. Widget acorde칩n para visualizaci칩n estructurada de cap칤tulos
    4. Vista tradicional mejorada con decoraciones para encabezados
    5. Campos adicionales para control de estado y visualizaci칩n
    
    CARACTER칈STICAS DE UX:
    - Visualizaci칩n condicional seg칰n el tipo de contenido
    - Decoraciones visuales para distinguir tipos de l칤neas
    - Iconograf칤a consistente (游늶) para identificaci칩n de cap칤tulos
    - Integraci칩n transparente con el flujo est치ndar de Odoo
    
    INTEGRACI칍N:
    - Hereda de: sale.view_order_form (vista est치ndar de Odoo)
    - Interact칰a con: capitulo.wizard, sale.order.line, capitulo.tecnico
    - Widgets personalizados: capitulos_accordion, section_and_note_one2many
    
    SEGURIDAD:
    - Restricci칩n por grupos: sales_team.group_sale_salesman
    - Visibilidad condicional seg칰n estado del pedido
    - Campos readonly para preservar integridad de encabezados
-->
<odoo>
    <!-- 
        HERENCIA DE VISTA DE PEDIDO DE VENTAS
        ====================================
        
        PROP칍SITO:
        - Extiende la funcionalidad est치ndar de pedidos de venta
        - Integra la gesti칩n de cap칤tulos t칠cnicos sin romper el flujo existente
        - Proporciona una experiencia de usuario mejorada para presupuestos complejos
        
        ESTRATEGIA DE HERENCIA:
        - Utiliza XPath para modificaciones precisas y no invasivas
        - Mantiene compatibilidad con otras extensiones
        - Preserva la funcionalidad est치ndar de Odoo
        
        MODIFICACIONES:
        1. A침ade bot칩n de gesti칩n de cap칤tulos en toolbar
        2. Reemplaza completamente el campo order_line con contenedor inteligente
        3. A침ade campos de control y estado despu칠s del order_line original
        
        COMPATIBILIDAD:
        - Compatible con m칩dulos est치ndar de ventas
        - No interfiere con workflows existentes
        - Mantiene API est치ndar de sale.order
    -->
    <record id="view_order_form_inherit_capitulo" model="ir.ui.view">
        <field name="name">sale.order.form.inherit.capitulo</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="arch" type="xml">
            <!-- 
                MODIFICACI칍N 1: BOT칍N DE GESTI칍N DE CAP칈TULOS
                ============================================
                
                UBICACI칍N: Despu칠s del bot칩n "Enviar por Email"
                PROP칍SITO: Acceso directo al wizard de gesti칩n de cap칤tulos
                
                CARACTER칈STICAS:
                - Posicionamiento estrat칠gico en la barra de herramientas
                - Texto descriptivo y claro: "Gestionar Cap칤tulos"
                - Estilo secundario para no competir con acciones principales
                - Restricci칩n de seguridad: solo vendedores
                - Visibilidad condicional: solo en estados draft/sent
                
                COMPORTAMIENTO:
                - Abre el wizard capitulo.wizard en ventana modal
                - Mantiene contexto del pedido actual
                - Permite a침adir m칰ltiples cap칤tulos consecutivamente
                
                SEGURIDAD:
                - groups="sales_team.group_sale_salesman": Solo vendedores
                - invisible="state not in ['draft', 'sent']": Solo en estados editables
            -->
            <xpath expr="//button[@name='action_quotation_send']" position="after">
                <button name="action_add_capitulo" 
                        string="Gestionar Cap칤tulos" 
                        type="object" 
                        class="btn-secondary" 
                        groups="sales_team.group_sale_salesman" 
                        invisible="state not in ['draft', 'sent']"/>
            </xpath>
            
            <!-- 
                MODIFICACI칍N 2: REEMPLAZO DEL CAMPO ORDER_LINE
                ==============================================
                
                ESTRATEGIA: Reemplazo completo con contenedor inteligente
                PROP칍SITO: Visualizaci칩n dual seg칰n el tipo de contenido
                
                CONTENEDOR PRINCIPAL:
                - Clase CSS: "capitulos-container" para estilos espec칤ficos
                - Dos modos de visualizaci칩n mutuamente excluyentes
                
                MODO 1: ACORDE칍N DE CAP칈TULOS (tiene_multiples_capitulos = True)
                - Para presupuestos con estructura de cap칤tulos
                - Widget especializado: capitulos_accordion
                - Visualizaci칩n jer치rquica y colapsable
                
                MODO 2: VISTA TRADICIONAL (tiene_multiples_capitulos = False)
                - Para presupuestos simples o sin estructura
                - Widget est치ndar mejorado: section_and_note_one2many
                - Decoraciones para distinguir tipos de l칤neas
            -->
            <xpath expr="//field[@name='order_line']" position="replace">
                <div class="capitulos-container">
                    <!-- 
                        MODO ACORDE칍N: CAP칈TULOS ESTRUCTURADOS
                        =====================================
                        
                        CONDICI칍N: invisible="not tiene_multiples_capitulos"
                        ACTIVACI칍N: Cuando el pedido tiene cap칤tulos t칠cnicos organizados
                        
                        CARACTER칈STICAS:
                        - T칤tulo prominente con icono 游늶 y color corporativo
                        - Widget personalizado: capitulos_accordion
                        - Visualizaci칩n jer치rquica: Cap칤tulo > Secci칩n > Productos
                        - Funcionalidad de colapso/expansi칩n por cap칤tulo
                        - Resumen de totales por cap칤tulo y secci칩n
                        
                        WIDGET capitulos_accordion:
                        - Renderiza estructura jer치rquica de cap칤tulos
                        - Permite navegaci칩n intuitiva por secciones
                        - Muestra totales y subtotales
                        - Mantiene estado de expansi칩n/colapso
                        - Integra acciones de edici칩n contextual
                    -->
                    <div invisible="not tiene_multiples_capitulos">
                        <h4 style="margin-bottom: 15px; color: #007bff;">游늶 Cap칤tulos del Presupuesto</h4>
                        <field name="capitulos_agrupados" widget="capitulos_accordion" nolabel="1"/>
                    </div>
                    
                    <!-- 
                        MODO TRADICIONAL: VISTA LINEAL MEJORADA
                        ======================================
                        
                        CONDICI칍N: invisible="tiene_multiples_capitulos"
                        ACTIVACI칍N: Cuando el pedido no tiene estructura de cap칤tulos
                        
                        CARACTER칈STICAS:
                        - Widget est치ndar: section_and_note_one2many
                        - Decoraciones visuales para tipos de l칤neas
                        - Edici칩n inline (editable="bottom")
                        - Handle para reordenamiento manual
                        - Campos readonly condicionales para encabezados
                        
                        DECORACIONES:
                        - decoration-info="es_encabezado_capitulo": Azul para cap칤tulos
                        - decoration-warning="es_encabezado_seccion": Amarillo para secciones
                        
                        CAMPOS READONLY CONDICIONALES:
                        - Los encabezados no son editables directamente
                        - Preserva la integridad de la estructura
                        - Evita modificaciones accidentales
                        
                        CAMPOS OCULTOS:
                        - es_encabezado_capitulo: Control de tipo de l칤nea
                        - es_encabezado_seccion: Control de tipo de l칤nea
                    -->
                    <div invisible="tiene_multiples_capitulos">
                        <field name="order_line" widget="section_and_note_one2many">
                            <list decoration-info="es_encabezado_capitulo" 
                                  decoration-warning="es_encabezado_seccion" 
                                  editable="bottom">
                                <!-- Handle para reordenamiento manual -->
                                <field name="sequence" widget="handle"/>
                                
                                <!-- Producto: readonly para encabezados -->
                                <field name="product_id" 
                                       readonly="es_encabezado_capitulo or es_encabezado_seccion"/>
                                
                                <!-- Descripci칩n: readonly para encabezados -->
                                <field name="name" 
                                       readonly="es_encabezado_capitulo or es_encabezado_seccion"/>
                                
                                <!-- Cantidad: readonly para encabezados -->
                                <field name="product_uom_qty" 
                                       readonly="es_encabezado_capitulo or es_encabezado_seccion"/>
                                
                                <!-- Unidad de medida: readonly para encabezados -->
                                <field name="product_uom" 
                                       readonly="es_encabezado_capitulo or es_encabezado_seccion"/>
                                
                                <!-- Precio unitario: readonly para encabezados -->
                                <field name="price_unit" 
                                       readonly="es_encabezado_capitulo or es_encabezado_seccion"/>
                                
                                <!-- Subtotal: siempre calculado -->
                                <field name="price_subtotal"/>
                                
                                <!-- Campos de control ocultos -->
                                <field name="es_encabezado_capitulo" invisible="1"/>
                                <field name="es_encabezado_seccion" invisible="1"/>
                            </list>
                        </field>
                    </div>
                </div>
            </xpath>
            
            <!-- 
                MODIFICACI칍N 3: CAMPOS ADICIONALES DE CONTROL
                =============================================
                
                UBICACI칍N: Despu칠s del campo order_line original
                PROP칍SITO: A침adir campos de estado y control para la funcionalidad de cap칤tulos
                
                CAMPOS A칌ADIDOS:
                1. capitulo_ids: Relaci칩n Many2many con cap칤tulos t칠cnicos
                2. tiene_multiples_capitulos: Campo computed para control de visualizaci칩n
                
                CARACTER칈STICAS:
                - Visibilidad condicional seg칰n contenido
                - Widget many2many_tags para visualizaci칩n compacta
                - Campo de control oculto para l칩gica de interfaz
            -->
            <xpath expr="//field[@name='order_line']" position="after">
                <!-- 
                    CAMPO: capitulo_ids
                    ==================
                    
                    TIPO: Many2many hacia capitulo.tecnico
                    PROP칍SITO: Mostrar relaci칩n con cap칤tulos t칠cnicos asociados
                    
                    CARACTER칈STICAS:
                    - Widget: many2many_tags (visualizaci칩n compacta como etiquetas)
                    - Visibilidad: invisible="not capitulo_ids" (solo si hay cap칤tulos)
                    - Funcionalidad: Permite ver y gestionar cap칤tulos asociados
                    - UX: Proporciona acceso r치pido a cap칤tulos relacionados
                -->
                <field name="capitulo_ids" 
                       invisible="not capitulo_ids" 
                       widget="many2many_tags"/>
                
                <!-- 
                    CAMPO: tiene_multiples_capitulos
                    ===============================
                    
                    TIPO: Boolean computed
                    PROP칍SITO: Control de visualizaci칩n entre modos acorde칩n/tradicional
                    
                    CARACTER칈STICAS:
                    - Siempre invisible: invisible="1"
                    - Campo computed: Calculado autom치ticamente por el modelo
                    - L칩gica: Determina si mostrar acorde칩n o vista tradicional
                    - Uso: Condici칩n para visibilidad de contenedores principales
                -->
                <field name="tiene_multiples_capitulos" invisible="1"/>
            </xpath>
        </field>
    </record>
</odoo>
