<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documentación Técnica - Sistema de Gestión de Capítulos</title>
    <style>
        @page {
            size: A4;
            margin: 2cm;
            @bottom-center {
                content: "Página " counter(page);
                font-size: 10px;
                color: #666;
            }
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: none;
            margin: 0;
            padding: 20px;
            background: white;
        }
        
        .cover-page {
            text-align: center;
            padding: 100px 0;
            page-break-after: always;
            border-bottom: 3px solid #007bff;
        }
        
        .cover-title {
            font-size: 2.5em;
            color: #2c3e50;
            margin-bottom: 30px;
            font-weight: 700;
        }
        
        .cover-subtitle {
            font-size: 1.5em;
            color: #34495e;
            margin-bottom: 50px;
        }
        
        .cover-info {
            font-size: 1.1em;
            color: #7f8c8d;
            line-height: 2;
        }
        
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            margin-top: 40px;
            page-break-before: always;
            font-size: 2em;
        }
        
        h1:first-of-type {
            page-break-before: auto;
            margin-top: 0;
        }
        
        h2 {
            color: #34495e;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
            margin-top: 30px;
            font-size: 1.5em;
        }
        
        h3 {
            color: #2980b9;
            margin-top: 25px;
            border-left: 4px solid #3498db;
            padding-left: 15px;
            font-size: 1.3em;
        }
        
        h4 {
            color: #2980b9;
            margin-top: 20px;
            font-size: 1.1em;
        }
        
        h5 {
            color: #34495e;
            margin-top: 15px;
            font-size: 1em;
            font-weight: 600;
        }
        
        code {
            background-color: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            color: #e74c3c;
        }
        
        pre {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            overflow-x: auto;
            margin: 15px 0;
            page-break-inside: avoid;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.85em;
            line-height: 1.4;
        }
        
        pre code {
            background: none;
            padding: 0;
            color: #333;
        }
        
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 15px 0;
            page-break-inside: avoid;
            font-size: 0.9em;
        }
        
        table th,
        table td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }
        
        table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        
        table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        blockquote {
            border-left: 4px solid #3498db;
            margin: 15px 0;
            padding: 10px 20px;
            background-color: #f8f9fa;
            font-style: italic;
        }
        
        ul, ol {
            margin: 10px 0;
            padding-left: 30px;
        }
        
        li {
            margin: 5px 0;
        }
        
        .toc {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
            page-break-inside: avoid;
        }
        
        .toc h2 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
        }
        
        .toc ul {
            list-style-type: none;
            padding-left: 0;
        }
        
        .toc li {
            margin: 8px 0;
            padding-left: 20px;
        }
        
        .toc a {
            text-decoration: none;
            color: #2980b9;
        }
        
        .toc a:hover {
            text-decoration: underline;
        }
        
        .page-break {
            page-break-before: always;
        }
        
        .no-break {
            page-break-inside: avoid;
        }
        
        .highlight {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }
        
        .info-box {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .warning-box {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .success-box {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
        }
        
        /* Estilos para sintaxis de código */
        .language-python .keyword { color: #0000ff; }
        .language-python .string { color: #008000; }
        .language-python .comment { color: #808080; }
        .language-javascript .keyword { color: #0000ff; }
        .language-javascript .string { color: #008000; }
        .language-javascript .comment { color: #808080; }
        .language-css .property { color: #0000ff; }
        .language-css .value { color: #008000; }
        .language-xml .tag { color: #0000ff; }
        .language-xml .attribute { color: #ff0000; }
        
        @media print {
            body {
                padding: 0;
            }
            
            .cover-page {
                padding: 50px 0;
            }
            
            h1, h2, h3 {
                page-break-after: avoid;
            }
            
            pre, table, .info-box, .warning-box, .success-box {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <!-- PORTADA -->
    <div class="cover-page">
        <h1 class="cover-title">DOCUMENTACIÓN TÉCNICA</h1>
        <h2 class="cover-subtitle">Sistema de Gestión de Capítulos</h2>
        <div class="cover-info">
            <p><strong>Módulo:</strong> Capítulos Contratados para Odoo</p>
            <p><strong>Versión:</strong> 1.0</p>
            <p><strong>Fecha:</strong> Diciembre 2024</p>
            <p><strong>Tecnologías:</strong> Python, JavaScript (OWL), XML, CSS</p>
            <p><strong>Framework:</strong> Odoo 16+</p>
        </div>
    </div>

    <!-- ÍNDICE -->
    <div class="toc">
        <h2>ÍNDICE</h2>
        <ul>
            <li><a href="#informacion-general">1. Información General del Proyecto</a></li>
            <li><a href="#estructura-proyecto">2. Estructura del Proyecto</a></li>
            <li><a href="#componentes-principales">3. Componentes Principales</a></li>
            <li><a href="#flujo-sincronizacion">4. Flujo de Sincronización JavaScript ↔ Python</a></li>
            <li><a href="#arquitectura-sistema">5. Arquitectura del Sistema</a></li>
            <li><a href="#modelos-datos">6. Modelos de Datos (Python)</a></li>
            <li><a href="#widget-javascript">7. Widget JavaScript</a></li>
            <li><a href="#vistas-xml">8. Vistas XML</a></li>
            <li><a href="#estilos-css">9. Estilos CSS</a></li>
            <li><a href="#casos-uso">10. Casos de Uso</a></li>
            <li><a href="#instalacion">11. Instalación y Configuración</a></li>
            <li><a href="#debugging">12. Debugging y Troubleshooting</a></li>
        </ul>
    </div>

    <!-- CONTENIDO PRINCIPAL -->
    <h1 id="informacion-general">1. INFORMACIÓN GENERAL DEL PROYECTO</h1>
    
    <div class="info-box">
        <strong>Descripción:</strong> Sistema integral para la gestión de capítulos técnicos en presupuestos de venta de Odoo. Permite crear, organizar y gestionar servicios agrupados con productos configurables, incluyendo condiciones particulares editables.
    </div>

    <h3>Interconexiones JavaScript ↔ Python</h3>
    <p>Este sistema implementa una comunicación bidireccional completa entre el frontend JavaScript y el backend Python, utilizando el framework OWL de Odoo y llamadas RPC para sincronización en tiempo real.</p>

    <h4>Patrón de Comunicación</h4>
    <pre><code>┌─────────────────┐    JSON/RPC    ┌─────────────────┐
│   JAVASCRIPT    │ ←──────────→   │     PYTHON      │
│   (Frontend)    │                │   (Backend)     │
└─────────────────┘                └─────────────────┘
        │                                   │
        ├── Estado Local (state)            ├── Modelos (ORM)
        ├── Métodos de UI                   ├── Métodos de Negocio
        ├── Eventos DOM                     ├── Validaciones
        └── Comunicación ORM                └── Persistencia DB</code></pre>

    <h1 id="estructura-proyecto">2. ESTRUCTURA DEL PROYECTO</h1>

    <pre><code>capitulos/
├── __manifest__.py                 # Configuración del módulo
├── models/                         # Modelos de datos (Python)
│   ├── sale_order.py              # Extensión del modelo Sale Order
│   ├── capitulo.py                # Modelo de capítulos técnicos
│   └── capitulo_seccion.py        # Modelo de secciones
├── wizard/                         # Asistentes (Python)
│   └── capitulo_wizard.py         # Wizard para gestión de capítulos
├── views/                          # Vistas XML
│   ├── sale_order_views.xml       # Vistas del presupuesto
│   ├── capitulo_views.xml         # Vistas de capítulos
│   └── capitulo_wizard_view.xml   # Vista del wizard
├── static/src/                     # Recursos frontend
│   ├── js/
│   │   └── capitulos_accordion_widget.js  # Widget principal
│   ├── css/
│   │   └── capitulos_accordion.css        # Estilos del acordeón
│   └── xml/
│       └── capitulos_accordion_templates.xml  # Templates OWL
└── security/
    └── ir.model.access.csv        # Permisos de acceso</code></pre>

    <h1 id="componentes-principales">3. COMPONENTES PRINCIPALES</h1>

    <h2>3.1 Modelos de Datos (Python)</h2>

    <h3>A) SaleOrder (sale_order.py)</h3>
    <pre><code class="language-python">class SaleOrder(models.Model):
    _inherit = 'sale.order'
    
    # CAMPOS PRINCIPALES
    capitulo_ids = fields.Many2many('capitulo.contrato', string='Capítulos Aplicados')
    capitulos_agrupados = fields.Text(compute='_compute_capitulos_agrupados')
    tiene_multiples_capitulos = fields.Boolean(compute='_compute_tiene_multiples_capitulos')
    
    # MÉTODOS CLAVE
    def _compute_capitulos_agrupados(self):
        """MÉTODO CENTRAL: Convierte líneas relacionales a JSON"""
        
    @api.model
    def add_product_to_section(self, order_id, capitulo_name, seccion_name, product_id, quantity):
        """Añade producto a sección específica"""
        
    @api.model
    def save_condiciones_particulares(self, order_id, capitulo_name, seccion_name, condiciones_text):
        """Guarda condiciones particulares"""</code></pre>

    <h3>B) SaleOrderLine (sale_order.py)</h3>
    <pre><code class="language-python">class SaleOrderLine(models.Model):
    _inherit = 'sale.order.line'
    
    # CAMPOS DE ESTRUCTURA
    es_encabezado_capitulo = fields.Boolean(default=False)
    es_encabezado_seccion = fields.Boolean(default=False)
    condiciones_particulares = fields.Text()
    
    # MÉTODOS DE PROTECCIÓN
    def unlink(self):
        """Previene eliminación de encabezados"""
        
    def write(self, vals):
        """Previene modificación de campos críticos"""
        
    def create(self, vals):
        """Controla creación de nuevas líneas"""</code></pre>

    <h2>3.2 Widget JavaScript (capitulos_accordion_widget.js)</h2>

    <h3>Clase Principal: CapitulosAccordionWidget</h3>
    <pre><code class="language-javascript">export class CapitulosAccordionWidget extends Component {
    static template = "capitulos.CapitulosAccordionWidget";
    
    setup() {
        this.state = useState({ 
            collapsedChapters: {},      // Estado de colapso/expansión
            editingLine: null,          // Línea en edición
            editValues: {},             // Valores temporales de edición
            condicionesParticulares: {} // Cache de condiciones
        });
        
        this.orm = useService("orm");           // Servicio ORM para comunicación
        this.notification = useService("notification");  // Notificaciones
        this.dialog = useService("dialog");     // Diálogos modales
    }
    
    // PROPIEDADES COMPUTADAS
    get parsedData() { /* Parsea JSON del backend */ }
    get chapters() { /* Convierte datos a estructura de capítulos */ }
    
    // MÉTODOS DE INTERFAZ
    toggleChapter(chapterName) { /* Colapsar/expandir capítulo */ }
    getSections(chapter) { /* Obtener secciones de un capítulo */ }
    
    // MÉTODOS DE GESTIÓN DE PRODUCTOS
    async addProductToSection(chapterName, sectionName) { /* Añadir producto */ }
    async deleteLine(lineId) { /* Eliminar producto */ }
    
    // MÉTODOS DE EDICIÓN INLINE
    startEditLine(lineId) { /* Iniciar edición */ }
    async saveEdit() { /* Guardar cambios */ }
    cancelEdit() { /* Cancelar edición */ }
    
    // MÉTODOS DE CONDICIONES PARTICULARES
    updateCondicionesParticulares(chapterName, sectionName, value) { /* Actualizar texto */ }
    async saveCondicionesParticulares(chapterName, sectionName, value) { /* Guardar en servidor */ }
    getCondicionesParticulares(chapterName, sectionName) { /* Obtener texto */ }
    
    // MÉTODOS DE DEBUGGING
    async forceRefresh() { /* Forzar actualización */ }
    debugState() { /* Inspeccionar estado */ }
}</code></pre>

    <h1 id="flujo-sincronizacion">4. FLUJO COMPLETO DE SINCRONIZACIÓN JAVASCRIPT ↔ PYTHON</h1>

    <h2>Métodos de Interconexión Principales</h2>

    <h3>A) Maximizar/Minimizar Capítulos (Solo Frontend)</h3>
    <pre><code class="language-javascript">// JavaScript: toggleChapter(chapterName)
toggleChapter(chapterName) {
    this.state.collapsedChapters = {
        ...this.state.collapsedChapters,
        [chapterName]: !this.state.collapsedChapters[chapterName]
    };
}</code></pre>
    
    <div class="info-box">
        <strong>Estado Local:</strong> <code>this.state.collapsedChapters = { "Capítulo 1": true }</code><br>
        <strong>Comunicación:</strong> NO requiere comunicación con Python<br>
        <strong>Persistencia:</strong> Solo durante la sesión del usuario
    </div>

    <h3>B) Gestión de Productos (JS → Python)</h3>
    <pre><code class="language-javascript">// JavaScript: addProductToSection()
async addProductToSection(chapterName, sectionName) {
    const result = await this.orm.call(
        'sale.order',
        'add_product_to_section',
        [orderId, chapterName, sectionName, productId, 1.0]
    );
    await this.props.record.load();
    this.render();
}</code></pre>

    <pre><code class="language-python"># Python: add_product_to_section()
@api.model
def add_product_to_section(self, order_id, capitulo_name, seccion_name, product_id, quantity=1.0):
    # 1. Buscar capítulo y sección
    # 2. Crear nueva línea de producto
    # 3. Forzar recálculo de JSON
    order._compute_capitulos_agrupados()
    return {'success': True, 'line_id': new_line.id}</code></pre>

    <h3>C) Condiciones Particulares (Híbrido)</h3>
    <pre><code class="language-javascript">// JavaScript: Estado híbrido (local + servidor)
getCondicionesParticulares(chapterName, sectionName) {
    // Prioridad 1: Estado local (cambios inmediatos)
    const localValue = this.state.condicionesParticulares[sectionKey];
    if (localValue !== undefined) return localValue;
    
    // Prioridad 2: Datos del servidor (persistidos)
    return this.parsedData[chapterName]?.sections[sectionName]?.condiciones_particulares || '';
}</code></pre>

    <h2>Estructura JSON de Intercambio</h2>
    <pre><code class="language-json">{
  "Capítulo 1": {
    "sections": {
      "Sección A": {
        "lines": [
          {
            "id": 123,
            "product_name": "Producto X",
            "product_uom_qty": 2.0,
            "price_unit": 100.0,
            "price_subtotal": 200.0
          }
        ],
        "condiciones_particulares": "Texto editable"
      }
    },
    "total": 200.0
  }
}</code></pre>

    <h1 id="casos-uso">10. CASOS DE USO</h1>

    <h2>Caso de Uso 1: Crear Nuevo Presupuesto con Capítulos</h2>
    <div class="success-box">
        <strong>Actor:</strong> Usuario comercial<br>
        <strong>Objetivo:</strong> Crear un presupuesto estructurado por capítulos técnicos
    </div>

    <ol>
        <li>Usuario crea nuevo presupuesto de venta</li>
        <li>Accede al wizard de capítulos</li>
        <li>Selecciona capítulos técnicos aplicables</li>
        <li>Sistema genera estructura automáticamente</li>
        <li>Usuario añade productos a cada sección</li>
        <li>Completa condiciones particulares</li>
        <li>Confirma presupuesto</li>
    </ol>

    <h2>Caso de Uso 2: Editar Productos en Capítulo Existente</h2>
    <div class="success-box">
        <strong>Actor:</strong> Usuario técnico<br>
        <strong>Objetivo:</strong> Modificar productos y cantidades en un capítulo
    </div>

    <ol>
        <li>Usuario abre presupuesto existente</li>
        <li>Navega al widget de capítulos</li>
        <li>Expande capítulo deseado</li>
        <li>Hace clic en "Editar" en línea de producto</li>
        <li>Modifica cantidad y precio</li>
        <li>Guarda cambios</li>
        <li>Sistema recalcula totales automáticamente</li>
    </ol>

    <h1 id="instalacion">11. INSTALACIÓN Y CONFIGURACIÓN</h1>

    <h2>Requisitos del Sistema</h2>
    <ul>
        <li><strong>Odoo:</strong> Versión 16.0 o superior</li>
        <li><strong>Python:</strong> 3.8+</li>
        <li><strong>Dependencias:</strong> sale, stock, product</li>
        <li><strong>Navegador:</strong> Chrome 90+, Firefox 88+, Safari 14+</li>
    </ul>

    <h2>Pasos de Instalación</h2>
    <ol>
        <li>Copiar el módulo al directorio de addons de Odoo</li>
        <li>Actualizar lista de aplicaciones</li>
        <li>Instalar el módulo "Gestión de Capítulos"</li>
        <li>Configurar permisos de usuario</li>
        <li>Crear capítulos técnicos base</li>
        <li>Probar funcionalidad en presupuesto de prueba</li>
    </ol>

    <h1 id="debugging">12. DEBUGGING Y TROUBLESHOOTING</h1>

    <h2>Métodos de Debugging JavaScript</h2>
    <pre><code class="language-javascript">// Inspeccionar estado del widget
this.debugState();

// Forzar actualización desde servidor
await this.forceRefresh();

// Verificar datos parseados
console.log('Parsed Data:', this.parsedData);

// Verificar estado de colapso
console.log('Collapsed Chapters:', this.state.collapsedChapters);</code></pre>

    <h2>Métodos de Debugging Python</h2>
    <pre><code class="language-python"># Logging en métodos críticos
import logging
_logger = logging.getLogger(__name__)

def add_product_to_section(self, ...):
    _logger.info(f"Añadiendo producto {product_id} a {capitulo_name}/{seccion_name}")
    
# Verificar JSON generado
def _compute_capitulos_agrupados(self):
    result = json.loads(self.capitulos_agrupados or '{}')
    _logger.debug(f"JSON generado: {result}")</code></pre>

    <h2>Problemas Comunes y Soluciones</h2>
    
    <div class="warning-box">
        <strong>Problema:</strong> Widget no se actualiza después de añadir producto<br>
        <strong>Solución:</strong> Verificar que se llama a <code>this.props.record.load()</code> y <code>this.render()</code>
    </div>

    <div class="warning-box">
        <strong>Problema:</strong> Condiciones particulares no se guardan<br>
        <strong>Solución:</strong> Verificar que el método <code>save_condiciones_particulares</code> encuentra la línea correcta
    </div>

    <div class="warning-box">
        <strong>Problema:</strong> Error al eliminar productos<br>
        <strong>Solución:</strong> Verificar permisos de eliminación y que no sean encabezados de capítulo/sección
    </div>

    <h2>Logs Importantes</h2>
    <ul>
        <li><strong>JavaScript Console:</strong> Errores de frontend y estado del widget</li>
        <li><strong>Odoo Server Log:</strong> Errores de backend y validaciones</li>
        <li><strong>Network Tab:</strong> Llamadas RPC y respuestas del servidor</li>
        <li><strong>Database Log:</strong> Consultas SQL y transacciones</li>
    </ul>

    <div class="info-box">
        <strong>Nota:</strong> Para debugging avanzado, activar el modo desarrollador de Odoo y usar las herramientas de desarrollo del navegador.
    </div>

    <hr style="margin: 40px 0; border: none; border-top: 2px solid #3498db;">
    
    <div style="text-align: center; color: #7f8c8d; font-size: 0.9em; margin-top: 40px;">
        <p><strong>Documentación Técnica - Sistema de Gestión de Capítulos</strong></p>
        <p>Generado automáticamente | Versión 1.0 | Diciembre 2024</p>
    </div>
</body>
</html>